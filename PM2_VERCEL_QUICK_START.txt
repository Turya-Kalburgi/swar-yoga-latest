# ðŸš€ PM2 Auto-Restart & Vercel Deployment - Quick Reference

## What Just Changed âœ¨

### 1. PM2 Auto-Restart Enabled
- **Backend:** Restarts every 1 hour (memory leak prevention)
- **Frontend:** Restarts every 30 minutes (stability)
- **Auto-crash recovery:** Max 15 restarts with 10s min uptime
- **Memory limits:** 500MB per service (auto-restarts if exceeded)
- **Auto-start on reboot:** System boot will auto-start services

### 2. Deployment Scripts Created
- `PM2_SETUP.sh` - Complete PM2 setup automation
- `DEPLOY_TO_VERCEL.sh` - One-command Vercel deployment
- `DEPLOYMENT_GUIDE.md` - Full documentation

---

## ðŸŽ¯ How to Use

### Start PM2 Auto-Restart (Local Development)

```bash
./PM2_SETUP.sh
```

**What happens:**
1. Installs PM2 globally
2. Starts backend + frontend with auto-restart enabled
3. Configures auto-start on system reboot
4. Shows status and logs

**Result:**
```
pm2 status
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App Name        â”‚ PID  â”‚ Status   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ swar-backend    â”‚ 1234 â”‚ online âœ“ â”‚
â”‚ swar-frontend   â”‚ 5678 â”‚ online âœ“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Deploy to Vercel (Production)

```bash
./DEPLOY_TO_VERCEL.sh
```

**What happens:**
1. Checks Vercel CLI installed
2. Builds project locally
3. Pushes to GitHub main branch
4. Deploys to Vercel production
5. App goes live at `https://swar-yoga-dec1.vercel.app`

**Pre-requisites:**
- Vercel account linked
- MongoDB URI in Vercel env vars
- GitHub repo connected

---

## ðŸ“Š Key Features

### Auto-Restart Protection

| Scenario | Action |
|----------|--------|
| App crashes | Auto-restart âœ“ |
| Memory > 500MB | Auto-restart âœ“ |
| Process hangs | Graceful shutdown + restart âœ“ |
| System reboot | Auto-start services âœ“ |
| Periodic cleanup | Restart every 1-30 min âœ“ |

### Monitoring

```bash
# View live logs
pm2 logs

# Monitor CPU/Memory
pm2 monit

# Check app status
pm2 status

# View specific app logs
pm2 logs swar-backend
pm2 logs swar-frontend
```

---

## ðŸ“‹ Checklist After Deployment

- [ ] Run `./PM2_SETUP.sh` to start services
- [ ] Verify `pm2 status` shows both apps online
- [ ] Check `pm2 logs` for errors
- [ ] Run `./DEPLOY_TO_VERCEL.sh` to deploy
- [ ] Test frontend at `https://swar-yoga-dec1.vercel.app`
- [ ] Verify user login works
- [ ] Check data persistence
- [ ] Monitor `pm2 logs` for 5 minutes
- [ ] Verify Vercel dashboard shows deployment successful

---

## ðŸ”§ Configuration Details

### Backend Auto-Restart (`ecosystem.config.cjs`)
```
autorestart: true              âœ“ On crash
max_restarts: 15               âœ“ Limit crash loops
min_uptime: 10s                âœ“ Only count if 10s+ running
max_memory_restart: 500M       âœ“ Memory leak protection
cron_restart: '0 * * * *'      âœ“ Every hour
env: NODE_ENV='production'     âœ“ Production mode
```

### Frontend Auto-Restart
```
autorestart: true              âœ“ On crash
max_restarts: 15               âœ“ Limit crash loops
max_memory_restart: 500M       âœ“ Memory leak protection
cron_restart: '*/30 * * * *'   âœ“ Every 30 minutes
env: NODE_ENV='development'    âœ“ Dev mode for Vite
```

### Vercel Config (`vercel.json`)
```
Build: npm run build           âœ“ Builds to /dist
Output: dist                   âœ“ Serves dist folder
Functions: Max 30s timeout     âœ“ API endpoints
Environment: MongoDB + NODE    âœ“ Configured
```

---

## ðŸš¨ Troubleshooting

### App keeps crashing

**Check logs:**
```bash
pm2 logs swar-backend --err
```

**Increase restart limit:**
Edit `ecosystem.config.cjs` â†’ increase `max_restarts: 20`

---

### Vercel build fails

**Test locally:**
```bash
npm run build
npm run lint
```

**Check env vars in Vercel Dashboard:**
- Settings â†’ Environment Variables
- Verify MONGODB_URI is set

---

### Data not persisting

**Check X-User-ID header:**
1. Open browser DevTools â†’ Network tab
2. Make API request
3. Verify X-User-ID header present

**Check backend logs:**
```bash
pm2 logs swar-backend
```

---

## ðŸ“š Full Documentation

See `DEPLOYMENT_GUIDE.md` for:
- Detailed architecture diagram
- Complete PM2 command reference
- Vercel environment variable setup
- Local vs production comparison
- Extensive troubleshooting guide

---

## âœ… Status

âœ“ PM2 Auto-Restart Enabled  
âœ“ Vercel Deployment Ready  
âœ“ Automated Setup Scripts Created  
âœ“ Comprehensive Documentation Added  
âœ“ Changes Committed & Pushed  

**Next:** Run `./PM2_SETUP.sh` followed by `./DEPLOY_TO_VERCEL.sh`

---

**Last Updated:** December 9, 2025
